// schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// === NextAuth.js Models ===

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// === USERS ===

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String?

  // Settings
  servingsDefault Int @default(2)

  // Calorie tracking
  gender             String?   // 'male' | 'female'
  dailyCalorieTarget Int?      // Дневной лимит ккал
  birthDate          DateTime?
  weightKg           Float?
  heightCm           Float?
  activityLevel      String?   // sedentary, light, moderate, active, very_active

  // Relations
  accounts    Account[]
  sessions    Session[]
  allergies   UserAllergy[]
  preferences UserPreference[]
  mealPlans   MealPlan[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UserAllergy {
  id       String @id @default(cuid())
  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  allergen String // milk, eggs, nuts, etc.

  @@unique([userId, allergen])
}

model UserPreference {
  id       String @id @default(cuid())
  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  preferenceType String // diet, dislike, favorite
  value          String // vegan, onion, pasta
}

// === PRODUCTS ===

model Product {
  id          String  @id @default(cuid())
  name        String
  description String?
  category    String
  subcategory String?
  barcode     String? @unique
  imageUrl    String?

  // External IDs
  usdaFdcId       String?
  openFoodFactsId String?

  // Measurement
  defaultUnit   String @default("g")
  gramsPerPiece Float?
  gramsPerCup   Float?
  packageSize   Float?  // Кратность (размер упаковки в граммах)

  // Shopping
  isAlwaysOwned Boolean @default(false) // Продукт всегда есть дома (специи)

  // Relations
  nutrition         ProductNutrition?
  storage           ProductStorage?
  seasonality       ProductSeasonality?
  dietaryInfo       ProductDietaryInfo?
  substitutesFrom   ProductSubstitute[] @relation("SubstituteFrom")
  substitutesTo     ProductSubstitute[] @relation("SubstituteTo")
  recipeIngredients RecipeIngredient[]
  shoppingListItems ShoppingListItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProductNutrition {
  id        String  @id @default(cuid())
  productId String  @unique
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Per 100g
  calories      Float
  protein       Float
  fat           Float
  fatSaturated  Float?
  carbohydrates Float
  sugar         Float?
  fiberTotal    Float?
  fiberSoluble  Float?
  sodium        Float?

  // Glycemic
  glycemicIndex Float?
  glycemicLoad  Float?

  // Vitamins (% DRI)
  vitaminA  Float?
  vitaminC  Float?
  vitaminD  Float?
  vitaminE  Float?
  vitaminK  Float?
  vitaminB1 Float?
  vitaminB2 Float?
  vitaminB6 Float?
  vitaminB12 Float?

  // Minerals (% DRI)
  calcium   Float?
  iron      Float?
  magnesium Float?
  potassium Float?
  zinc      Float?
}

model ProductStorage {
  id        String  @id @default(cuid())
  productId String  @unique
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  shelfLifePantry       Int?
  shelfLifeRefrigerator Int?
  shelfLifeFreezer      Int?
  shelfLifeAfterOpening Int?

  storageConditions String  // JSON array
  storageTempMin    Float?
  storageTempMax    Float?
  storageTips       String?
}

model ProductSeasonality {
  id        String  @id @default(cuid())
  productId String  @unique
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  isSeasonal       Boolean @default(false)
  monthsAvailable  String  // JSON array [1,2,3...]
  peakSeasonMonths String? // JSON array
  region           String  @default("russia")
}

model ProductDietaryInfo {
  id        String  @id @default(cuid())
  productId String  @unique
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  isVegan      Boolean @default(false)
  isVegetarian Boolean @default(false)
  isGlutenFree Boolean @default(false)
  isDairyFree  Boolean @default(false)
  isNutFree    Boolean @default(false)

  allergens  String? // JSON array
  novaGroup  Int?    // 1-4
  nutriScore String? // A-E
}

model ProductSubstitute {
  id            String @id @default(cuid())
  fromProductId String
  toProductId   String

  fromProduct Product @relation("SubstituteFrom", fields: [fromProductId], references: [id])
  toProduct   Product @relation("SubstituteTo", fields: [toProductId], references: [id])

  ratio   Float   @default(1.0)
  context String?
  notes   String?
}

// === RECIPES ===

model Recipe {
  id          String  @id @default(cuid())
  name        String
  description String?
  imageUrl    String?

  // Source
  author    String?
  sourceUrl String?

  // Time (minutes)
  prepTime    Int
  cookTime    Int
  passiveTime Int?
  totalTime   Int

  // Servings
  servings    Int
  servingSize String?
  yield       String?

  // Classification (JSON arrays)
  mealTypes      String // ["breakfast", "lunch"]
  courses        String // ["main", "soup"]
  cuisines       String? // ["russian", "italian"]
  cookingMethods String // ["boiling", "frying"]
  occasions      String? // ["everyday", "holiday"]
  seasons        String? // ["winter", "all_year"]

  // Difficulty
  difficultyLevel   Int     @default(3) // 1-5
  requiredEquipment String? // JSON array

  // Dietary (computed from ingredients)
  isVegan      Boolean @default(false)
  isVegetarian Boolean @default(false)
  isGlutenFree Boolean @default(false)
  allergens    String? // JSON array

  // Nutrition per serving
  caloriesPerServing Float?
  proteinPerServing  Float?
  fatPerServing      Float?
  carbsPerServing    Float?

  // Cost
  estimatedCost  Float?
  costPerServing Float?
  budgetLevel    String? // budget, moderate, premium

  // Relations
  ingredients   RecipeIngredient[]
  steps         RecipeStep[]
  mealPlanItems MealPlanRecipe[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RecipeIngredient {
  id       String @id @default(cuid())
  recipeId String
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  amount        Float
  unit          String
  amountInGrams Float // Normalized for shopping list

  preparation String?
  notes       String?
  groupName   String?
  isOptional  Boolean @default(false)
  sortOrder   Int     @default(0)
}

model RecipeStep {
  id       String @id @default(cuid())
  recipeId String
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  stepNumber      Int
  instruction     String
  durationMinutes Int?
  imageUrl        String?
  tips            String? // JSON array

  temperatureValue Float?
  temperatureUnit  String? // C or F
}

// === MEAL PLANNING ===

model MealPlan {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name      String?
  startDate DateTime
  endDate   DateTime

  // Relations
  recipes      MealPlanRecipe[]
  shoppingList ShoppingList?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MealPlanRecipe {
  id         String   @id @default(cuid())
  mealPlanId String
  mealPlan   MealPlan @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)

  recipeId String
  recipe   Recipe @relation(fields: [recipeId], references: [id])

  date     DateTime
  mealType String   // breakfast, lunch, dinner, snack
  servings Int
}

// === SHOPPING LIST ===

model ShoppingList {
  id         String    @id @default(cuid())
  mealPlanId String?   @unique
  mealPlan   MealPlan? @relation(fields: [mealPlanId], references: [id])

  name String?

  items ShoppingListItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ShoppingListItem {
  id             String       @id @default(cuid())
  shoppingListId String
  shoppingList   ShoppingList @relation(fields: [shoppingListId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  amount Float
  unit   String

  // Store section for grouping
  storeSection String?

  // Status
  isChecked   Boolean @default(false)
  isExcluded  Boolean @default(false) // Excluded due to allergy
  excludeNote String? // Exclusion reason

  sortOrder Int @default(0)
}
